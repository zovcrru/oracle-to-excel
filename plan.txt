## план программы на Python 3.14 для экспорта данных Oracle в Excel

### Структура программы (функциональный подход)

#### **Модуль 1: Конфигурация и валидация (`config.py` - опционально или внутри основного файла)**

**Функция `load_config(env_file: str = '.env') -> dict`**
- Загрузка переменных из .env файла через `python-dotenv`
- Валидация обязательных параметров из списка `REQUIRED_CONFIG`
- Установка значений по умолчанию для опциональных параметров
- Маскирование паролей в логах (замена на `***`)
- Возврат словаря с конфигурацией или выброс исключения при отсутствии обязательных параметров

```python
REQUIRED_CONFIG = ['ORACLE_USER', 'ORACLE_PASSWORD', 'ORACLE_DSN']
OPTIONAL_CONFIG = {
    'POOL_MIN': 1,
    'POOL_MAX': 5,
    'LOG_LEVEL': 'INFO',
    'OUTPUT_DIR': './exports',
    'FETCH_ARRAY_SIZE': 1000
}
```

#### **Модуль 2: Система логирования**

**Функция `setup_logging(log_level: str, log_file: str) -> logging.Logger`**
- Создание логгера с именем модуля
- Настройка двух handlers: файловый (с ротацией через `RotatingFileHandler`) и консольный
- Формат логов: `%(asctime)s - %(name)s - %(levelname)s - %(funcName)s:%(lineno)d - %(message)s`
- Установка уровня логирования из конфигурации
- Возврат сконфигурированного логгера

**Функция `log_sql_query(logger: logging.Logger, query: str, params: dict) -> None`**
- Логирование SQL-запроса с параметрами (маскирование чувствительных данных)
- Подсчет и логирование длины запроса
- Уровень: DEBUG для полного запроса, INFO для краткой информации

**Функция `log_execution_stats(logger: logging.Logger, rows_count: int, execution_time: float) -> None`**
- Логирование статистики выполнения: количество строк, время выполнения
- Расчет скорости обработки (строк/секунду)

#### **Модуль 3: Работа с базой данных**

**Функция `create_connection(config: dict, logger: logging.Logger) -> oracledb.Connection`**
- Создание подключения к Oracle Database через `oracledb.connect()`
- Настройка параметров: `threaded=True`, `encoding='UTF-8'`
- Retry-логика с экспоненциальной задержкой (максимум 3 попытки)
- Логирование успешного подключения и ошибок
- Использование DSN из конфигурации

**Функция `fetch_data_from_oracle(connection: oracledb.Connection, session_id: int, logger: logging.Logger) -> tuple[list, list]`**
- Создание курсора с установкой `cursor.arraysize` для оптимизации
- Параметризованный SQL-запрос:
  ```sql
  SELECT * FROM POOL3.REPORT_EXCEL_SN
  WHERE SES = :session_id
  ORDER BY NUM
  ```
- Извлечение имен колонок из `cursor.description`
- Получение данных через `cursor.fetchall()`
- Логирование SQL-запроса и количества полученных строк
- Возврат кортежа: (список имен колонок, список строк данных)
- Обработка исключений `oracledb.DatabaseError`

**Функция `convert_oracle_types(row: tuple, logger: logging.Logger) -> list`**
- Конвертация типов данных Oracle в Python-типы:
  - `DATE` → `datetime` → строка в формате ISO
  - `NUMBER` → `int` или `float` (проверка на дробную часть)
  - `None` → пустая строка `''` или `'NULL'` (настраивается)
  - `CLOB` → строка (если встретится)
- Обработка потенциальных ошибок конвертации
- Возврат списка сконвертированных значений

#### **Модуль 4: Генерация Excel**

**Функция `sanitize_filename(filename: str, logger: logging.Logger) -> str`**
- Удаление или замена недопустимых символов в имени файла
- Ограничение длины имени (максимум 255 символов)
- Добавление временной метки если требуется уникальность
- Проверка на зарезервированные имена Windows (CON, PRN, AUX и т.д.)

**Функция `calculate_column_widths(headers: list, data: list[list], max_width: int = 50) -> dict`**
- Расчет оптимальной ширины для каждой колонки
- Анализ длины заголовков и данных
- Ограничение максимальной ширины для длинных текстов
- Возврат словаря: `{column_letter: width}`

**Функция `create_excel_file(headers: list, data: list[list], output_path: str, logger: logging.Logger) -> str`**
- Создание нового Workbook через `openpyxl.Workbook()`
- Получение активного листа и установка заголовка
- Запись заголовков с форматированием:
  - Жирный шрифт (`Font(bold=True)`)
  - Заливка фона (`PatternFill(fill_type='solid', fgColor='CCCCCC')`)
  - Выравнивание (`Alignment(horizontal='center', vertical='center')`)
  - Границы ячеек (`Border`)
- Запись данных построчно с обработкой длинных текстов:
  - Текст > 32767 символов усекается с предупреждением в логе
  - Применение `wrap_text=True` для длинных строк
- Применение автоширины колонок через `calculate_column_widths()`
- Заморозка первой строки: `ws.freeze_panes = 'A2'`
- Добавление автофильтра: `ws.auto_filter.ref = ws.dimensions`
- Сохранение файла
- Логирование пути сохранения и размера файла
- Возврат полного пути к файлу

**Функция `add_progress_bar(total_rows: int) -> callable`**
- Создание генератора или простой функции для отображения прогресса
- Использование `tqdm` для визуализации (опционально)
- Обновление каждые N строк для производительности
- Возврат функции-обновителя прогресса

#### **Модуль 5: Валидация и безопасность**

**Функция `validate_session_id(session_id: str, logger: logging.Logger) -> int`**
- Проверка, что session_id является числом
- Проверка диапазона (положительное число)
- Возврат валидированного integer или выброс `ValueError`

**Функция `check_output_directory(output_dir: str, logger: logging.Logger) -> None`**
- Проверка существования директории
- Создание директории если не существует (`os.makedirs(exist_ok=True)`)
- Проверка прав на запись через `os.access(output_dir, os.W_OK)`
- Выброс `PermissionError` если нет прав

**Функция `validate_table_access(connection: oracledb.Connection, logger: logging.Logger) -> bool`**
- Проверка существования таблицы и доступа к ней
- Тестовый запрос: `SELECT COUNT(*) FROM POOL3.REPORT_EXCEL_SN WHERE ROWNUM = 1`
- Возврат `True` при успехе, `False` или исключение при ошибке

#### **Модуль 6: Аргументы командной строки**

**Функция `parse_arguments() -> argparse.Namespace`**
- Использование `argparse` для парсинга аргументов:
  - `--session` (обязательный): номер сессии
  - `--output` (опциональный): имя выходного файла (по умолчанию: `report_{session}_{timestamp}.xlsx`)
  - `--env-file` (опциональный): путь к .env файлу (по умолчанию: `.env`)
  - `--output-dir` (опциональный): директория для сохранения (переопределяет .env)
  - `--verbose` (флаг): включение DEBUG-логирования
- Добавление help-сообщений для каждого аргумента
- Возврат namespace с распарсенными аргументами

#### **Модуль 7: Главная функция**

**Функция `main() -> int`**

Последовательность выполнения:

1. **Инициализация**
   - Парсинг аргументов командной строки
   - Загрузка конфигурации из .env
   - Настройка логирования
   - Логирование старта программы с версией Python

2. **Валидация**
   - Валидация session_id
   - Проверка выходной директории и прав
   - Генерация и санитаризация имени файла

3. **Подключение к БД**
   - Создание подключения (с retry)
   - Проверка доступа к таблице
   - Использование контекстного менеджера для автозакрытия

4. **Извлечение данных**
   - Запуск таймера выполнения
   - Получение данных из Oracle
   - Конвертация типов для каждой строки
   - Инициализация прогресс-бара (если данных много)

5. **Генерация Excel**
   - Создание Excel файла с форматированием
   - Применение стилей и автоширины
   - Сохранение файла

6. **Финализация**
   - Остановка таймера
   - Логирование статистики выполнения
   - Вывод пути к созданному файлу
   - Закрытие подключения
   - Возврат кода завершения (0 - успех, 1 - ошибка)

7. **Обработка ошибок**
   - Отдельные блоки `try-except` для каждого этапа
   - Специфичные исключения: `oracledb.DatabaseError`, `FileNotFoundError`, `PermissionError`, `ValueError`
   - Логирование полного traceback на уровне ERROR
   - Graceful shutdown при критических ошибках

### Обновленная структура .env файла

```env
# Oracle Database Connection (обязательные)
ORACLE_USER=POOL3
ORACLE_PASSWORD=your_secure_password
ORACLE_DSN=hostname:1521/service_name

# Connection Settings (опциональные)
POOL_MIN=1
POOL_MAX=5
FETCH_ARRAY_SIZE=1000

# Application Settings
LOG_LEVEL=INFO
LOG_FILE=./logs/oracle_export.log
OUTPUT_DIR=./exports

# Excel Settings
MAX_COLUMN_WIDTH=50
NULL_VALUE_REPLACEMENT=
WRAP_LONG_TEXT=true

# Performance
SHOW_PROGRESS_BAR=true
PROGRESS_UPDATE_INTERVAL=100
```

### Дополнительные библиотеки

- **python-dotenv** (1.2.1+): управление переменными окружения[1]
- **oracledb** (2.x+): Thin-mode драйвер для Oracle[2][3]
- **openpyxl** (3.1.x+): работа с Excel файлами[4]
- **tqdm** (опциональный): прогресс-бары для CLI
- **argparse**: встроенный парсер аргументов командной строки

### Примеры использования

```bash
# Базовое использование
python oracle_to_excel.py --session 12345

# С кастомным выходным файлом
python oracle_to_excel.py --session 12345 --output my_report.xlsx

# С verbose-логированием
python oracle_to_excel.py --session 12345 --verbose

# С кастомной директорией
python oracle_to_excel.py --session 12345 --output-dir /path/to/reports

# С кастомным .env файлом
python oracle_to_excel.py --session 12345 --env-file production.env
```

### Обработка специфики данных таблицы REPORT_EXCEL_SN

**Специфичные поля для обработки:**
- **DATE поле (DV)**: конвертация в строку ISO 8601 или локальный формат
- **VARCHAR2 поля (FIELDS1-21, STR и др.)**: обработка NULL → пустая строка, усечение длинных текстов
- **NUMBER поля (SES, NUM, NUMG и др.)**: конвертация с сохранением точности, проверка на NULL
- **CHAR(1) поле (CONTENT)**: сохранение как строка с trim пробелов

### Оптимизация производительности

1. **Batch fetching**: `cursor.arraysize = 1000` для снижения количества roundtrips[5]
2. **Statement caching**: автоматически включен в oracledb
3. **Прогресс-бар**: обновление каждые 100 строк для минимизации накладных расходов
4. **Пакетная запись в Excel**: запись блоками по 1000 строк для больших датасетов
5. **Освобождение памяти**: использование генераторов для обработки данных построчно (при необходимости)

### Безопасность

- Маскирование паролей в логах
- Параметризованные SQL-запросы против SQL-инъекций
- Валидация входных данных
- Санитаризация имен файлов
- Проверка прав доступа перед операциями записи
- Использование контекстных менеджеров для гарантированного закрытия ресурсов

