==================================================================================== test session starts =====================================================================================
platform win32 -- Python 3.14.0, pytest-9.0.1, pluggy-1.6.0 -- C:\Work\2025\oracle-to-excel\.venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Work\2025\oracle-to-excel
configfile: pyproject.toml (WARNING: ignoring pytest config in setup.cfg!)
plugins: cov-7.0.0
collecting ... collected 3 items

tests/test_env_config.py::TestLoggingPasswordProtection::test_print_config_summary_masks_password_in_logs FAILED [ 33%]
tests/test_env_config.py::TestLoggingPasswordProtection::test_print_config_summary_console_masks_password FAILED [ 66%]
tests/test_env_config.py::TestLoggingPasswordProtection::test_print_config_without_masking_shows_password PASSED [100%]

========================================================================================== FAILURES ==========================================================================================
_______________________________________________________ TestLoggingPasswordProtection.test_print_config_summary_masks_password_in_logs _______________________________________________________

self = <tests.test_env_config.TestLoggingPasswordProtection object at 0x0000020A08B9B390>
oracle_env_file = WindowsPath('C:/Users/olgaz/AppData/Local/Temp/pytest-of-unknown/pytest-14/test_print_config_summary_mask0/.env')
caplog = <_pytest.logging.LogCaptureFixture object at 0x0000020A0AE8DFD0>

    def test_print_config_summary_masks_password_in_logs(self, oracle_env_file: Path, caplog):
        """Проверка, что print_config_summary не выводит пароли в лог."""
        with patch.dict('os.environ', {}, clear=True):
            config = load_config(str(oracle_env_file))
    
        logger = logging.getLogger('test_security')
        logger.setLevel(logging.INFO)
    
        with caplog.at_level(logging.INFO, logger='test_security'):
            print_config_summary(config, mask_sensitive=True, logger=logger)
    
        log_output = caplog.text
    
        # Пароль НЕ должен попасть в лог
        assert 'SecretPassword123' not in log_output, 'КРИТИЧНО: Пароль обнаружен в логах!'
    
        # Замаскированная версия должна быть в логе
>       assert '***' in log_output
E       AssertionError: assert '***' in 'INFO     test_security:env_config.py:370 ============================================================\nINFO     test_security:env_config.py:371 \u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\nINFO     test_security:env_config.py:372 ============================================================\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Db Type                     : oracle\nINFO     test_security:env_config.py:391  Db Connect Uri              : oracle://testuser:%2A%2A%2A@localhost:1521/TESTDB\nINFO     test_security:env_config.py:391  Lib Dir                     : /opt/oracle/instantclient_21_1\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Log Level                   : DEBUG\nINFO     test_security:env_config.py:391  Log File                    : ./logs/oracle_export.log\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Output Dir                  : ./test_exports\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Fetch Array Size            : 1000\nINFO     test_security:env_config.py:391  Chunk Size                  : 5000\nINFO     test_security:env_config.py:391  Query Timeout               : 300\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [Excel]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Max Column Width            : 50\nINFO     test_security:env_config.py:391  Max Rows Per Sheet          : 1000000\nINFO     test_security:env_config.py:391  Wrap Long Text              : True\nINFO     test_security:env_config.py:391  Null Value Replacement      : \nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Enable Batch Processing     : False\nINFO     test_security:env_config.py:391  Batch Size                  : 50000\nINFO     test_security:env_config.py:391  Show Progress Bar           : True\nINFO     test_security:env_config.py:391  Progress Update Interval    : 100\nINFO     test_security:env_config.py:395 \nINFO     test_security:env_config.py:396 ============================================================\n'

tests\test_env_config.py:207: AssertionError
------------------------------------------------------------------------------------- Captured log call --------------------------------------------------------------------------------------
INFO     test_security:env_config.py:370 ============================================================
INFO     test_security:env_config.py:371 КОНФИГУРАЦИЯ ПРИЛОЖЕНИЯ
INFO     test_security:env_config.py:372 ============================================================
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [База данных]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Db Type                     : oracle
INFO     test_security:env_config.py:391  Db Connect Uri              : oracle://testuser:%2A%2A%2A@localhost:1521/TESTDB
INFO     test_security:env_config.py:391  Lib Dir                     : /opt/oracle/instantclient_21_1
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [Логирование]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Log Level                   : DEBUG
INFO     test_security:env_config.py:391  Log File                    : ./logs/oracle_export.log
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [Экспорт]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Output Dir                  : ./test_exports
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [Производительность]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Fetch Array Size            : 1000
INFO     test_security:env_config.py:391  Chunk Size                  : 5000
INFO     test_security:env_config.py:391  Query Timeout               : 300
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [Excel]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Max Column Width            : 50
INFO     test_security:env_config.py:391  Max Rows Per Sheet          : 1000000
INFO     test_security:env_config.py:391  Wrap Long Text              : True
INFO     test_security:env_config.py:391  Null Value Replacement      : 
INFO     test_security:env_config.py:381 
INFO     test_security:env_config.py:382 [Батч обработка]
INFO     test_security:env_config.py:383 ----------------------------------------
INFO     test_security:env_config.py:391  Enable Batch Processing     : False
INFO     test_security:env_config.py:391  Batch Size                  : 50000
INFO     test_security:env_config.py:391  Show Progress Bar           : True
INFO     test_security:env_config.py:391  Progress Update Interval    : 100
INFO     test_security:env_config.py:395 
INFO     test_security:env_config.py:396 ============================================================
_______________________________________________________ TestLoggingPasswordProtection.test_print_config_summary_console_masks_password _______________________________________________________

self = <tests.test_env_config.TestLoggingPasswordProtection object at 0x0000020A0AECD6D0>
postgres_env_file = WindowsPath('C:/Users/olgaz/AppData/Local/Temp/pytest-of-unknown/pytest-14/test_print_config_summary_cons0/.env')
capsys = <_pytest.capture.CaptureFixture object at 0x0000020A0AE8E3C0>

    def test_print_config_summary_console_masks_password(self, postgres_env_file: Path, capsys):
        """Проверка маскировки паролей в консольном выводе."""
        with patch.dict('os.environ', {}, clear=True):
            config = load_config(str(postgres_env_file))
    
        print_config_summary(config, mask_sensitive=True, logger=None)
        captured = capsys.readouterr()
    
        assert 'MyP@ssw0rd!' not in captured.out, 'КРИТИЧНО: Пароль в консоли!'
>       assert 'postgresql://pguser:***@db.example.com:5432/testdb' in captured.out
E       AssertionError: assert 'postgresql://pguser:***@db.example.com:5432/testdb' in '\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n'
E        +  where '\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n' = CaptureResult(out='\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n', err='').out

tests\test_env_config.py:219: AssertionError
======================================================================================= tests coverage =======================================================================================
______________________________________________________________________ coverage: platform win32, python 3.14.0-final-0 _______________________________________________________________________

Coverage HTML written to dir htmlcov
================================================================================== short test summary info ===================================================================================
FAILED tests/test_env_config.py::TestLoggingPasswordProtection::test_print_config_summary_masks_password_in_logs - AssertionError: assert '***' in 'INFO     test_security:env_config.py:370 ============================================================\nINFO     test_security:env_config.py:371 \u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\nINFO     test_security:env_config.py:372 ============================================================\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Db Type                     : oracle\nINFO     test_security:env_config.py:391  Db Connect Uri              : oracle://testuser:%2A%2A%2A@localhost:1521/TESTDB\nINFO     test_security:env_config.py:391  Lib Dir                     : /opt/oracle/instantclient_21_1\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Log Level                   : DEBUG\nINFO     test_security:env_config.py:391  Log File                    : ./logs/oracle_export.log\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Output Dir                  : ./test_exports\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Fetch Array Size            : 1000\nINFO     test_security:env_config.py:391  Chunk Size                  : 5000\nINFO     test_security:env_config.py:391  Query Timeout               : 300\nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [Excel]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Max Column Width            : 50\nINFO     test_security:env_config.py:391  Max Rows Per Sheet          : 1000000\nINFO     test_security:env_config.py:391  Wrap Long Text              : True\nINFO     test_security:env_config.py:391  Null Value Replacement      : \nINFO     test_security:env_config.py:381 \nINFO     test_security:env_config.py:382 [\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\nINFO     test_security:env_config.py:383 ----------------------------------------\nINFO     test_security:env_config.py:391  Enable Batch Processing     : False\nINFO     test_security:env_config.py:391  Batch Size                  : 50000\nINFO     test_security:env_config.py:391  Show Progress Bar           : True\nINFO     test_security:env_config.py:391  Progress Update Interval    : 100\nINFO     test_security:env_config.py:395 \nINFO     test_security:env_config.py:396 ============================================================\n'
FAILED tests/test_env_config.py::TestLoggingPasswordProtection::test_print_config_summary_console_masks_password - AssertionError: assert 'postgresql://pguser:***@db.example.com:5432/testdb' in '\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n'
 +  where '\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n' = CaptureResult(out='\n============================================================\n\u041a\u041e\u041d\u0424\u0418\u0413\u0423\u0420\u0410\u0426\u0418\u042f \u041f\u0420\u0418\u041b\u041e\u0416\u0415\u041d\u0418\u042f\n============================================================\n\n[\u0411\u0430\u0437\u0430 \u0434\u0430\u043d\u043d\u044b\u0445]\n----------------------------------------\n Db Type                     : postgresql\n Db Connect Uri              : postgresql://pguser:%2A%2A%2A@ssw0rd!@db.example.com:5432/testdb\n\n[\u041b\u043e\u0433\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u0435]\n----------------------------------------\n Log Level                   : INFO\n Log File                    : ./logs/oracle_export.log\n\n[\u042d\u043a\u0441\u043f\u043e\u0440\u0442]\n----------------------------------------\n Output Dir                  : ./exports\n\n[\u041f\u0440\u043e\u0438\u0437\u0432\u043e\u0434\u0438\u0442\u0435\u043b\u044c\u043d\u043e\u0441\u0442\u044c]\n----------------------------------------\n Fetch Array Size            : 1000\n Chunk Size                  : 5000\n Query Timeout               : 300\n\n[Excel]\n----------------------------------------\n Max Column Width            : 50\n Max Rows Per Sheet          : 1000000\n Wrap Long Text              : True\n Null Value Replacement      : \n\n[\u0411\u0430\u0442\u0447 \u043e\u0431\u0440\u0430\u0431\u043e\u0442\u043a\u0430]\n----------------------------------------\n Enable Batch Processing     : False\n Batch Size                  : 50000\n Show Progress Bar           : True\n Progress Update Interval    : 100\n============================================================\n\n', err='').out
================================================================================ 2 failed, 1 passed in 0.64s =================================================================================
